#!/bin/sh

echo "Running version check..."
node scripts/check-versions.js

# 运行TypeScript编译检查
echo "Running TypeScript type check..."
bunx tsc --noEmit

if [ $? -ne 0 ]; then
  echo "TypeScript type check failed. Please fix the type errors before committing."
  exit 1
fi

# 运行单元测试
echo "Running unit tests..."
pnpm test --passWithNoTests

if [ $? -ne 0 ]; then
  echo "Unit tests failed. Please fix the test failures before committing."
  exit 1
fi

# 运行 E2E 测试
echo "Running E2E tests..."
pnpm test:e2e --passWithNoTests

if [ $? -ne 0 ]; then
  echo "E2E tests failed. Please fix the test failures before committing."
  exit 1
fi

# 只对暂存的TypeScript/JavaScript文件运行oxlint自动修复
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|jsx|tsx)$' || true)

if [ -n "$STAGED_FILES" ]; then
  echo "Running Oxlint fix on staged files..."
  echo "$STAGED_FILES" | xargs npm run format
  echo "$STAGED_FILES" | xargs npm run lint:fix

  # 重新添加修复后的文件到暂存区
  echo "$STAGED_FILES" | xargs git add
fi
