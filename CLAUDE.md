# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

NestJS-based backend server with PostgreSQL database (MikroORM), Redis caching, and Fastify web framework.

## Development Commands

```bash
# Install dependencies (requires pnpm >= 10.0.0, node >= 22.0.0)
pnpm install

# Development with hot reload
pnpm dev

# Build for production
pnpm build

# Start production server
pnpm start:prod

# Run tests
pnpm test                    # all tests
pnpm test:cov               # coverage report
pnpm test:e2e               # e2e tests

# Linting and formatting
pnpm lint                   # check linting
pnpm lint:fix               # auto-fix linting issues
pnpm format                 # format code
```

## Architecture

### Module Structure

- `src/app.module.ts` - Root module with global providers (interceptors, filters, guards, pipes)
- `src/features/` - Feature modules (user, health, etc.) following domain-driven design
- `src/global/` - Global module with cross-cutting concerns:
  - `crypto/` - Cryptographic services (Ed25519 signing/verification, argon2 password hashing)
  - `db/` - Database configuration and entities
  - `redis/` - Redis configuration
  - `id/` - Snowflake ID generation service
  - `http-context/` - HTTP context service (cookies, session)
  - `cronjob/` - Scheduled tasks
- `src/aspects/` - Cross-cutting concerns:
  - `decorators/` - Custom decorators (`@CurrentUser`, `@ClientIP`)
  - `filters/` - Exception filters (validation, HTTP, default)
  - `guards/` - Auth guards, throttler guard
  - `interceptors/` - Response formatter

### Database (MikroORM)

- **Driver**: PostgreSQL
- **Entities**: Extend `EntityBase` which provides `id` (snowflake), `createdAt`, `updatedAt`
- **Primary Keys**: Snowflake IDs generated by `IdService`
- **Config**: `src/mikro-orm.config.ts` handles CLI vs runtime configuration

### Key Patterns

- **Auth**: Session-based auth using Redis. Use `@UseGuards(AuthGuard)` and `@CurrentUser()` decorator for protected routes
- **Request validation**: DTOs with class-validator, global ValidationPipe (returns 422 on error)
- **Response format**: Global `FormatterInterceptor` wraps all responses
- **Error handling**: Filter chain (ValidationFilter → HttpFilter → DefaultFilter)

### Shared DTOs

- `src/shared/dto/` - Common DTOs: `PaginationDto`, `SortDto`, `TimeRangeDto`, `VerifyCodeDto`

## Tech Stack

- **Framework**: NestJS 11 with Fastify adapter
- **ORM**: MikroORM 6 with PostgreSQL
- **Cache**: Redis (ioredis)
- **Logging**: nestjs-pino
- **Validation**: class-validator, class-transformer
- **Auth**: argon2 for password hashing
- **ID Generation**: @sapphire/snowflake
- **Linting**: oxlint
- **Testing**: Jest with ts-jest

### Code Conventions

- Follow the project's existing code style and patterns
- Avoid try-catch unless necessary; let errors propagate to the global Filter
- Write only e2e tests and service unit tests; skip controller unit tests
- Use DTOs for parameter validation
- When writing Markdown docs, avoid tables; use lists instead
- When getting config, use `configService.getOrThrow()` for required config, or `configService.get()` for optional config

### Delivery Self-Check List

1. [ ] Review your code changes for better implementation, unused variables, or functions
2. [ ] Check for any unused variables or functions generated during coding
3. [ ] Verify `pnpm lint` and `pnpm build` pass
4. [ ] If modifying services, ensure unit tests are written
5. [ ] If adding new endpoints, ensure e2e tests are written
6. [ ] Update documentation if needed
