# 版本管理规范

## 概述

本文档定义了项目中依赖包版本管理的规范和最佳实践，确保项目的稳定性和可重现性。

## 版本固定原则

### 1. 强制使用精确版本

所有依赖包必须使用**精确版本号**，禁止使用版本范围前缀：

✅ **正确示例：**
```json
{
  "dependencies": {
    "@nestjs/core": "11.0.1",
    "rxjs": "7.8.1"
  }
}
```

❌ **错误示例：**
```json
{
  "dependencies": {
    "@nestjs/core": "^11.0.1",    // 使用了 ^ 前缀
    "rxjs": "~7.8.1",             // 使用了 ~ 前缀
    "lodash": "*",                // 使用了通配符
    "axios": "latest"             // 使用了 latest
  }
}
```

### 2. 禁止使用的版本格式

- `^1.2.3` - 兼容版本（允许升级到1.x.x的最新版本）
- `~1.2.3` - 补丁版本（允许升级到1.2.x的最新版本）
- `*` - 通配符版本
- `latest` - 最新版本
- `>=1.2.3` - 大于等于版本
- `>1.2.3` - 大于版本
- `<1.2.3` - 小于版本
- `<=1.2.3` - 小于等于版本

## 工程化约束

### 1. npm配置约束

项目中的 `.npmrc` 文件已配置以下约束：

```bash
# 安装包时保存精确版本号
save-exact=true

# 禁止使用^、~等版本范围前缀
save-prefix=""

# 禁止不稳定的版本
prefer-stable=true

# 严格检查版本冲突
strict-peer-dependencies=true
```

### 2. Pre-commit钩子检查

在 `.husky/pre-commit` 中添加了版本固定性检查：

- 当 `package.json` 被修改时，自动检查版本格式
- 发现使用版本范围时会阻止提交
- 提供明确的错误提示和修复建议

### 3. 版本检查脚本

提供了专门的版本检查脚本：

```bash
# 检查版本固定性
npm run check-versions
# 或
npm run version-check
```

脚本功能：
- 检查所有依赖类型（dependencies、devDependencies、peerDependencies）
- 识别版本范围前缀（^、~）
- 识别不稳定版本（*、latest）
- 提供详细的错误报告

### 4. 锁定文件

项目使用 `bun.lock` 文件确保依赖版本的一致性：

- 每次安装依赖时自动生成/更新
- 确保所有环境使用相同的依赖版本
- 必须提交到版本控制系统

## 最佳实践

### 1. 添加新依赖

添加新依赖时，使用以下命令确保版本固定：

```bash
# 使用精确版本安装
bun add package-name@1.2.3

# 开发依赖
bun add -d package-name@1.2.3
```

### 2. 更新依赖版本

更新依赖版本时，遵循以下流程：

1. **明确需求**：确定需要更新的具体版本
2. **测试兼容性**：在本地环境中测试新版本
3. **更新版本号**：修改 `package.json` 中的精确版本
4. **更新锁定文件**：运行 `bun install` 更新锁定文件
5. **验证功能**：确保项目功能正常
6. **提交变更**：提交 `package.json` 和 `bun.lock` 的变更

### 3. 依赖审查

定期审查项目依赖：

- **安全性**：检查是否有安全漏洞
- **维护性**：评估依赖包的维护状态
- **必要性**：移除不再使用的依赖
- **版本更新**：在必要时更新到稳定的新版本

## CI/CD集成

### 1. 版本检查阶段

在CI/CD流程中添加版本检查步骤：

```yaml
# 示例：GitHub Actions
- name: Check Version Constraints
  run: npm run check-versions
```

### 2. 锁定文件验证

确保锁定文件与package.json同步：

```yaml
# 示例：验证锁定文件
- name: Validate Lock File
  run: |
    bun install --frozen-lockfile
    git diff --exit-code bun.lock
```

## 故障排除

### 常见问题

#### 1. Pre-commit钩子阻止提交

**问题**：提交时被提示版本格式错误

**解决**：
1. 检查 `package.json` 中的版本格式
2. 将所有 `^` 或 `~` 前缀移除
3. 使用精确的版本号
4. 运行 `bun install` 更新锁定文件
5. 重新提交

#### 2. 依赖冲突

**问题**：不同包要求同一依赖的不同版本

**解决**：
1. 使用 `bun why package-name` 查看依赖关系
2. 考虑升级或降级相关包
3. 必要时使用 resolutions 字段强制版本

#### 3. 版本锁定文件不同步

**问题**：锁定文件与package.json不一致

**解决**：
1. 删除 `bun.lock` 文件
2. 运行 `bun install` 重新生成
3. 提交新的锁定文件

## 相关工具

- **版本检查脚本**：`scripts/check-versions.js`
- **Pre-commit钩子**：`.husky/pre-commit`
- **npm配置**：`.npmrc`
- **锁定文件**：`bun.lock`

## 总结

通过严格的版本管理规范，我们确保：

1. **稳定性**：避免因依赖自动升级导致的问题
2. **可重现性**：所有环境使用相同的依赖版本
3. **安全性**：通过锁定文件防止意外变更
4. **可维护性**：明确的版本控制策略便于团队协作

所有团队成员必须严格遵守这些规范，任何违反规范的行为都会被工程化流程自动阻止。